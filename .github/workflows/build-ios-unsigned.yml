name: Build XStreaming iOS (Unsigned IPA)

on:
  push:
    branches: ["ios"]
  workflow_dispatch:

jobs:
  build-unsigned-ipa:
    name: Build unsigned IPA
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ios

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 启用 Corepack，否则 Yarn 会报错
      - name: Enable Corepack
        run: corepack enable

      - name: Install Yarn dependencies
        run: yarn --frozen-lockfile

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods --no-document
          cd ios
          pod install --repo-update

      - name: Detect Xcode workspace/project and scheme
        id: detect
        working-directory: ios
        run: |
          WORKSPACE=$(ls *.xcworkspace 2>/dev/null | head -n1 || true)
          PROJECT=$(ls *.xcodeproj 2>/dev/null | head -n1 || true)
          if [ -n "$WORKSPACE" ]; then
            SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list | sed -n '/Schemes:/,/^$/p' | tail -n +2 | head -n1 | xargs)
          elif [ -n "$PROJECT" ]; then
            SCHEME=$(xcodebuild -project "$PROJECT" -list | sed -n '/Schemes:/,/^$/p' | tail -n +2 | head -n1 | xargs)
          else
            echo "No .xcworkspace or .xcodeproj found in ios/"
            exit 1
          fi
          echo "workspace=$WORKSPACE" >> $GITHUB_OUTPUT
          echo "project=$PROJECT" >> $GITHUB_OUTPUT
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT

      - name: Archive (CODE_SIGNING_ALLOWED=NO)
        working-directory: ios
        run: |
          set -e
          BUILD_DIR=$PWD/build
          mkdir -p "$BUILD_DIR"
          ARCHIVE_PATH="$BUILD_DIR/${{ steps.detect.outputs.scheme }}.xcarchive"
          if [ -n "${{ steps.detect.outputs.workspace }}" ]; then
            xcodebuild -workspace "${{ steps.detect.outputs.workspace }}" \
              -scheme "${{ steps.detect.outputs.scheme }}" \
              -configuration Release \
              -sdk iphoneos \
              -archivePath "$ARCHIVE_PATH" \
              clean archive \
              CODE_SIGNING_ALLOWED=NO
          else
            xcodebuild -project "${{ steps.detect.outputs.project }}" \
              -scheme "${{ steps.detect.outputs.scheme }}" \
              -configuration Release \
              -sdk iphoneos \
              -archivePath "$ARCHIVE_PATH" \
              clean archive \
              CODE_SIGNING_ALLOWED=NO
          fi

      - name: Create unsigned IPA
        working-directory: ios
        run: |
          set -e
          BUILD_DIR=$PWD/build
          SCHEME="${{ steps.detect.outputs.scheme }}"
          ARCHIVE_PATH="$BUILD_DIR/${SCHEME}.xcarchive"
          APP_PATH=$(find "$ARCHIVE_PATH" -name "*.app" -type d | head -n1)
          if [ -z "$APP_PATH" ]; then
            echo "No .app found!"
            exit 1
          fi
          OUT_DIR="$BUILD_DIR/unsigned"
          mkdir -p "$OUT_DIR"
          TMPDIR=$(mktemp -d)
          mkdir -p "$TMPDIR/Payload"
          cp -R "$APP_PATH" "$TMPDIR/Payload/"
          IPA_NAME="${SCHEME}-unsigned-$(date +%Y%m%d%H%M%S).ipa"
          pushd "$TMPDIR" >/dev/null
          zip -r "../$OUT_DIR/$IPA_NAME" Payload > /dev/null
          popd >/dev/null
          rm -rf "$TMPDIR"
          echo "Unsigned IPA created: $OUT_DIR/$IPA_NAME"

      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: XStreaming-iOS-Unsigned
          path: ios/build/unsigned/*.ipa
